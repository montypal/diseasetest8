<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epidemiology Vignettes: 100 Clinical Problems</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #2980b9;
            --accent: #16a085;
            --bg: #f5f7fa;
            --card: #ffffff;
            --text: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }

        header {
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1 { color: var(--primary); margin: 0; font-size: 2.2rem; }
        .subtitle { color: #7f8c8d; font-size: 1.1rem; margin-top: 10px; }

        /* Progress Bar */
        .progress-container {
            background: #dfe6e9;
            height: 12px;
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: -2px;
            font-size: 10px;
            color: #555;
            font-weight: bold;
        }

        /* Question Area */
        .category-badge {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 30px;
            color: #34495e;
            background: #f8f9fa;
            padding: 20px;
            border-left: 5px solid var(--accent);
            border-radius: 4px;
        }

        /* Options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } }

        .option-btn {
            background: #fff;
            border: 2px solid #bdc3c7;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
        }

        .option-btn:hover:not(:disabled) {
            border-color: var(--secondary);
            background: #f4faff;
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: #eef2f5;
        }

        .option-btn.correct {
            background-color: #d5f5e3 !important;
            border-color: #27ae60 !important;
            color: #0e6655;
        }

        .option-btn.wrong {
            background-color: #fadbd8 !important;
            border-color: #c0392b !important;
            color: #7b241c;
        }

        .option-btn:disabled { cursor: default; }

        /* Explanation / Feedback */
        .feedback-box {
            margin-top: 30px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 6px solid #ccc;
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .feedback-box.success { border-color: #27ae60; background: #eafaf1; }
        .feedback-box.error { border-color: #c0392b; background: #fdedec; }

        /* Tables */
        .calc-table {
            width: 100%;
            max-width: 500px;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .calc-table th, .calc-table td {
            border: 1px solid #dcdcdc;
            padding: 8px;
            text-align: center;
        }
        .calc-table th { background: #f1f2f6; color: #555; }
        .highlight { font-weight: bold; color: var(--secondary); }

        /* Navigation */
        .nav-area {
            margin-top: 30px;
            text-align: right;
        }
        .btn-next {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            cursor: pointer;
            display: none;
        }
        .btn-next:hover { background: #34495e; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Epidemiology Vignettes</h1>
        <div class="subtitle">100 Clinical Problems: Decipher the Data</div>
    </header>

    <div class="progress-container">
        <div class="progress-fill" id="progress-bar"></div>
        <div class="progress-text" id="progress-text">Question 1 of 100</div>
    </div>

    <div id="quiz-content">
        <div id="category-display" class="category-badge">Category</div>
        <div id="question-text" class="question-text">Loading...</div>
        
        <div id="options-container" class="options-grid"></div>

        <div id="feedback" class="feedback-box">
            <h3 id="feedback-title" style="margin-top:0;"></h3>
            <div id="feedback-body"></div>
        </div>

        <div class="nav-area">
            <button id="next-btn" class="btn-next" onclick="nextQuestion()">Next Question &rarr;</button>
        </div>
    </div>
    
    <div id="results-screen" style="display:none; text-align:center;">
        <h2 style="color:var(--secondary)">Quiz Complete!</h2>
        <p style="font-size:1.2rem;">You have finished all 100 questions.</p>
        <div style="font-size:3rem; font-weight:bold; margin:20px 0;" id="final-score"></div>
        <button class="btn-next" style="display:inline-block;" onclick="location.reload()">Restart Quiz</button>
    </div>
</div>

<script>
    /**
     * VIGNETTE GENERATOR ENGINE
     * Generates narrative problems where the user must extract variables.
     */

    const NAMES = ["Dr. Grace", "Dr. Aarav", "Dr. Kangin", "Dr. Alyssa", "Dr. Maggie"];
    const DISEASES = [
        "TikTok Tics", "Zoom Fatigue", "Netflix Neuralgia", "Snapchat Syndrome", 
        "Emoji Fever", "Hashtag Headache", "WiFi Wheeze", "Pixel Pox", 
        "Influencer Influenza", "Scroll Thumb", "Stream Sneeze", "Data Dizziness"
    ];

    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;

    // --- HELPER FUNCTIONS ---
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function randItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function round(num, decimals=2) { return Number(Math.round(num+'e'+decimals)+'e-'+decimals); }

    // --- GENERATORS ---

    // 1. Disease Association (Narrative)
    function generateAssocQuestion() {
        const name = randItem(NAMES);
        const disease = randItem(DISEASES);
        const exposure = "spending >6 hours online";
        
        let a = randInt(30, 80);  // Exposed + Sick
        let b = randInt(120, 200); // Exposed + Healthy
        let c = randInt(10, 30);  // Unexposed + Sick
        let d = randInt(150, 250); // Unexposed + Healthy

        const totalExposed = a + b;
        const totalUnexposed = c + d;
        const totalPop = totalExposed + totalUnexposed;

        const riskExposed = a / totalExposed;
        const riskUnexposed = c / totalUnexposed;
        const rr = round(riskExposed / riskUnexposed);
        const or = round((a * d) / (b * c));

        const type = Math.random() > 0.5 ? "RR" : "OR";
        const answer = type === "RR" ? rr : or;
        
        // Narrative construction
        const questionText = `
            ${name} conducted a study involving <strong>${totalPop}</strong> participants to investigate the link between ${exposure} and "${disease}". 
            Of the participants, <strong>${totalExposed}</strong> reported heavy internet usage. 
            At the end of the study, ${name} identified <strong>${a}</strong> cases of "${disease}" among the heavy users, 
            compared to only <strong>${c}</strong> cases among the remaining participants (the low-usage group).
            <br><br>
            Calculate the <strong>${type === "RR" ? "Relative Risk (RR)" : "Odds Ratio (OR)"}</strong>.
        `;

        // Distractors
        let distractors = new Set();
        distractors.add(round(answer * 1.5));
        distractors.add(round(answer / 1.5));
        distractors.add(round(answer + 0.8));
        distractors.add(round((a/(a+c))/(b/(b+d)))); 
        let opts = Array.from(distractors).slice(0, 3);
        while(opts.length < 3) opts.push(round(Math.random()*5));
        
        const explanation = `
            <p><strong>Deciphering the Text:</strong></p>
            <ul>
                <li>Exposed Total = ${totalExposed} (Given)</li>
                <li>Exposed Sick (a) = ${a} (Given)</li>
                <li>Exposed Healthy (b) = ${totalExposed} - ${a} = ${b}</li>
                <li>Unexposed Sick (c) = ${c} (Given)</li>
                <li>Unexposed Healthy (d) = Total Unexposed (${totalUnexposed}) - ${c} = ${d}</li>
            </ul>
            <table class="calc-table">
                <tr><th></th><th>Sick (+)</th><th>Healthy (-)</th></tr>
                <tr><td>Exposed</td><td>${a}</td><td>${b}</td></tr>
                <tr><td>Unexposed</td><td>${c}</td><td>${d}</td></tr>
            </table>
            ${type === "RR" ? 
                `<p><strong>Calculation (RR):</strong><br>
                 Risk(Exp) = ${a}/${totalExposed} = ${round(riskExposed, 3)}<br>
                 Risk(Unexp) = ${c}/${totalUnexposed} = ${round(riskUnexposed, 3)}<br>
                 RR = ${round(riskExposed, 3)} / ${round(riskUnexposed, 3)} = <strong>${rr}</strong></p>` : 
                `<p><strong>Calculation (OR):</strong><br>
                 OR = (${a} × ${d}) / (${b} × ${c})<br>
                 OR = ${a*d} / ${b*c} = <strong>${or}</strong></p>`
            }`;

        return { category: "Disease Association", text: questionText, correct: answer, options: opts, explanation: explanation };
    }

    // 2. Diagnostic Testing (Narrative)
    function generateTestQuestion() {
        const name = randItem(NAMES);
        const disease = randItem(DISEASES);
        
        let tp = randInt(60, 150);
        let fn = randInt(10, 40);
        let fp = randInt(20, 80);
        let tn = randInt(200, 400);

        const totalDiseased = tp + fn;
        const totalHealthy = fp + tn;
        const totalPosTests = tp + fp;
        const totalNegTests = fn + tn;
        const totalPop = totalDiseased + totalHealthy;

        const types = ["Sensitivity", "Specificity", "PPV", "NPV"];
        const target = randItem(types);
        
        let ans;
        if (target === "Sensitivity") ans = round((tp/totalDiseased)*100, 1) + "%";
        else if (target === "Specificity") ans = round((tn/totalHealthy)*100, 1) + "%";
        else if (target === "PPV") ans = round((tp/totalPosTests)*100, 1) + "%";
        else ans = round((tn/totalNegTests)*100, 1) + "%";

        // Narrative variations
        // Variant A: "Gold standard says X sick... Test found Y positive among them..."
        // Variant B: "Total population... X tested positive, but Y were false positives..."
        
        let questionText = "";
        if (Math.random() > 0.5) {
            questionText = `
                ${name} is validating a new rapid test for "${disease}" in a clinic of <strong>${totalPop}</strong> patients. 
                Gold standard testing confirmed that <strong>${totalDiseased}</strong> patients actually had the disease.
                <br>
                When the new rapid test was applied to these confirmed cases, it correctly identified <strong>${tp}</strong> of them. 
                Among the healthy patients, the test incorrectly flagged <strong>${fp}</strong> as positive.
                <br><br>
                Calculate the <strong>${target}</strong>.
            `;
        } else {
            questionText = `
                In a study of <strong>${totalPop}</strong> individuals, <strong>${totalHealthy}</strong> were confirmed to be disease-free. 
                The remaining individuals had "${disease}".
                <br>
                The new diagnostic test produced a total of <strong>${totalPosTests}</strong> positive results. 
                Upon closer inspection, <strong>${tp}</strong> of these positive results came from patients who actually had the disease.
                <br><br>
                Calculate the <strong>${target}</strong>.
            `;
        }

        // Distractors
        let opts = [];
        opts.push(round(Math.random()*100, 1)+"%");
        opts.push(round(Math.random()*100, 1)+"%");
        opts.push(round(Math.random()*100, 1)+"%");
        
        const explanation = `
            <p><strong>Deciphering the Text:</strong></p>
            <ul>
                <li>Total Diseased = ${totalDiseased} (TP + FN)</li>
                <li>Total Healthy = ${totalHealthy} (TN + FP)</li>
                <li>TP = ${tp}</li>
                <li>FP = ${fp}</li>
                <li>FN = ${fn} (Diseased - TP)</li>
                <li>TN = ${tn} (Healthy - FP)</li>
            </ul>
            <table class="calc-table">
                <tr><th></th><th>Disease (+)</th><th>Healthy (-)</th></tr>
                <tr><td>Test (+)</td><td>${tp} (TP)</td><td>${fp} (FP)</td></tr>
                <tr><td>Test (-)</td><td>${fn} (FN)</td><td>${tn} (TN)</td></tr>
            </table>
            <p><strong>Answer:</strong> ${ans}</p>`;

        return { category: "Diagnostic Testing", text: questionText, correct: ans, options: opts, explanation: explanation };
    }

    // 3. Vaccine Efficacy & HIT (Narrative)
    function generateVaccineQuestion() {
        const name = randItem(NAMES);
        const disease = randItem(DISEASES);
        const isHit = Math.random() > 0.6;

        if (isHit) {
            const r0 = randItem([2.5, 3, 4, 5, 6, 8, 10, 12, 15, 18]);
            const hit = round((1 - (1/r0)) * 100, 1) + "%";
            
            const questionText = `
                ${name} is tracking a highly contagious variant of "${disease}". 
                Epidemiological data suggests that for every single infected person, 
                an average of <strong>${r0}</strong> new infections are generated in a completely susceptible population.
                <br><br>
                What is the minimum <strong>Herd Immunity Threshold (HIT)</strong> required to stop the spread?
            `;

            let opts = [
                round((1 - (1/(r0+2))) * 100, 1) + "%",
                round((1/r0) * 100, 1) + "%",
                round((r0 * 5) + "%")
            ];

            const explanation = `
                <p><strong>Deciphering the Text:</strong><br>
                The text describes the basic reproduction number (R0) as <strong>${r0}</strong>.</p>
                <p><strong>Formula:</strong> HIT = 1 - (1 / R0)</p>
                <p><strong>Calculation:</strong><br>
                HIT = 1 - (1 / ${r0}) = 1 - ${round(1/r0, 3)} = <strong>${hit}</strong></p>`;
            
            return { category: "Herd Immunity", text: questionText, correct: hit, options: opts, explanation: explanation };

        } else {
            let totalVax = randInt(400, 800);
            let totalUnvax = randInt(400, 800);
            let casesVax = randInt(5, 40);
            let casesUnvax = randInt(60, 150); 
            
            // Text logic
            const questionText = `
                During a severe outbreak of "${disease}", ${name} monitored two groups. 
                Group A consisted of <strong>${totalVax}</strong> individuals who had received the new vaccine. 
                Group B consisted of <strong>${totalUnvax}</strong> individuals who declined the vaccine.
                <br>
                By the end of the season, only <strong>${casesVax}</strong> people in Group A got sick, 
                whereas <strong>${casesUnvax}</strong> people in Group B contracted the illness.
                <br><br>
                Calculate the <strong>Vaccine Efficacy (VE)</strong>.
            `;

            let arv = casesVax / totalVax;
            let aru = casesUnvax / totalUnvax;
            let ve = round(((aru - arv) / aru) * 100, 1) + "%";

            let opts = [
                round(((arv - aru) / arv) * 100, 1) + "%", 
                round(aru * 100, 1) + "%",
                round((casesUnvax - casesVax) / casesUnvax * 100, 1) + "%" 
            ];

            const explanation = `
                <p><strong>Deciphering the Text:</strong><br>
                Attack Rate Unvaccinated (ARu) = ${casesUnvax} / ${totalUnvax} = ${round(aru, 4)}<br>
                Attack Rate Vaccinated (ARv) = ${casesVax} / ${totalVax} = ${round(arv, 4)}</p>
                <p><strong>Calculation:</strong><br>
                VE = (ARu - ARv) / ARu<br>
                VE = (${round(aru,4)} - ${round(arv,4)}) / ${round(aru,4)}<br>
                VE = <strong>${ve}</strong></p>`;

            return { category: "Vaccine Efficacy", text: questionText, correct: ve, options: opts, explanation: explanation };
        }
    }

    // 4. Likelihood Ratios (Narrative)
    function generateLRQuestion() {
        const name = randItem(NAMES);
        const type = Math.random() > 0.5 ? "Positive Likelihood Ratio (LR+)" : "Negative Likelihood Ratio (LR-)";
        const typeShort = type.includes("+") ? "LR+" : "LR-";

        let sens = randItem([0.70, 0.80, 0.85, 0.90, 0.95]);
        let spec = randItem([0.70, 0.80, 0.85, 0.90, 0.95]);

        let ans;
        if (typeShort === "LR+") ans = round(sens / (1 - spec));
        else ans = round((1 - sens) / spec);

        const questionText = `
            ${name} reads a paper on a new diagnostic tool. 
            The paper reports that the test has a <strong>Sensitivity of ${sens*100}%</strong> 
            and a <strong>Specificity of ${spec*100}%</strong>.
            <br><br>
            Based on these parameters, calculate the <strong>${type}</strong>.
        `;

        let opts = [
            round(ans * 2),
            round(ans / 2),
            round(ans + 1.2)
        ];

        const explanation = `
            <p><strong>Deciphering the Text:</strong><br>
            Sensitivity = ${sens}<br>
            Specificity = ${spec}</p>
            ${typeShort === "LR+" ? 
            `<p><strong>Calculation (LR+):</strong><br>Sens / (1 - Spec) = ${sens} / ${round(1-spec,2)} = <strong>${ans}</strong></p>` : 
            `<p><strong>Calculation (LR-):</strong><br>(1 - Sens) / Spec = ${round(1-sens,2)} / ${spec} = <strong>${ans}</strong></p>`}
        `;

        return { category: "Likelihood Ratios", text: questionText, correct: ans, options: opts, explanation: explanation };
    }

    // --- MAIN INIT ---
    function initQuiz() {
        for(let i=0; i<25; i++) questions.push(generateAssocQuestion());
        for(let i=0; i<25; i++) questions.push(generateTestQuestion());
        for(let i=0; i<25; i++) questions.push(generateVaccineQuestion());
        for(let i=0; i<25; i++) questions.push(generateLRQuestion());
        
        questions.sort(() => Math.random() - 0.5); // Shuffle all
        renderQuestion();
    }

    function renderQuestion() {
        const q = questions[currentQuestionIndex];
        
        document.getElementById("progress-bar").style.width = ((currentQuestionIndex) / questions.length * 100) + "%";
        document.getElementById("progress-text").innerText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        
        document.getElementById("category-display").innerText = q.category;
        document.getElementById("question-text").innerHTML = q.text;
        document.getElementById("feedback").style.display = "none";
        document.getElementById("next-btn").style.display = "none";

        let allOpts = [...q.options];
        if(!allOpts.includes(q.correct)) allOpts.push(q.correct);
        allOpts.sort(() => Math.random() - 0.5);

        const container = document.getElementById("options-container");
        container.innerHTML = "";
        
        allOpts.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "option-btn";
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(btn, opt, q);
            container.appendChild(btn);
        });
    }

    function checkAnswer(btn, selectedVal, q) {
        const buttons = document.querySelectorAll(".option-btn");
        buttons.forEach(b => b.disabled = true);

        const isCorrect = (selectedVal === q.correct);
        
        if (isCorrect) {
            btn.classList.add("correct");
            document.getElementById("feedback").className = "feedback-box success";
            document.getElementById("feedback-title").innerText = "✅ Correct!";
            score++;
        } else {
            btn.classList.add("wrong");
            document.getElementById("feedback").className = "feedback-box error";
            document.getElementById("feedback-title").innerText = "❌ Incorrect";
            buttons.forEach(b => {
                if (b.innerText == q.correct) b.classList.add("correct");
            });
        }

        document.getElementById("feedback-body").innerHTML = q.explanation;
        document.getElementById("feedback").style.display = "block";
        document.getElementById("next-btn").style.display = "inline-block";
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
            renderQuestion();
        } else {
            showResults();
        }
    }

    function showResults() {
        document.getElementById("quiz-content").style.display = "none";
        document.getElementById("results-screen").style.display = "block";
        document.getElementById("final-score").innerText = `${score} / 100`;
        document.getElementById("progress-bar").style.width = "100%";
    }

    initQuiz();

</script>

</body>
</html>
